<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>reticle</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.117.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/GLTFLoader.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="container">
        <button id="xr-button">Tap To Start</button>
        <button id="model1-button">Load Model 1</button>
        <button id="model2-button">Load Model 2</button>
        <button id="model3-button">Load Model 3</button>
    </div>
    <script>
        // Three.js variables
        let renderer, camera, light, reticle, scene;

        // XR session variables
        let xrSession;
        let xrRefSpace;
        let xrViewerSpace;
        let xrHitTestSource;
        let planeDetected = false;
        let modelPlaced = false;

        // GLTF loader
        const loader = new THREE.GLTFLoader();

        // GLTF models
        let models = {
            'model1': '1.glb',
            'model2': '2.glb',
            'model3': '3.glb'
        };

        // Current model
        let currentModel = null;

        function setup() {
            // renderer
            renderer = new THREE.WebGLRenderer({
                antialias: false,
                alpha: true,
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);

            // light
            light = new THREE.DirectionalLight(0xffffff, 0.7);
            light.position.set(1, 1, 1).normalize();

            // reticle
            const innerRadius = 0.04; 
            const outerRadius = 0.05; 
            const thetaSegments = 30;
            const phiSegments = 1;
            const geometry = new THREE.RingGeometry(innerRadius, outerRadius, thetaSegments, phiSegments);
            const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
            reticle = new THREE.Mesh(geometry, material);
            reticle.rotation.set(Math.PI * -0.5, 0, 0);
            reticle.visible = false;

            // scene
            scene = new THREE.Scene();
            scene.add(light);
            scene.add(reticle);
        }

        function update() {
            xrSession.requestAnimationFrame((time, frame) => {
                const pose = frame.getViewerPose(xrRefSpace);
                reticle.visible = false;
                if (xrHitTestSource && pose) {
                    const hitTestResults = frame.getHitTestResults(xrHitTestSource);
                    if (hitTestResults.length > 0 && !planeDetected) {
                        planeDetected = true;
                        const pose = hitTestResults[0].getPose(xrRefSpace);
                        const position = pose.transform.position;
                        reticle.visible = true;
                        reticle.position.set(position.x, position.y, position.z);

                        if (!modelPlaced) {
                            loadModel(currentModel);
                            modelPlaced = true;
                        }

                        xrHitTestSource.cancel();
                    }
                }
            });
            renderer.render(scene, camera);
        }

        function loadModel(modelName) {
            loader.load(
                models[modelName],
                function (gltf) {
                    if (model) {
                        scene.remove(model);
                    }
                    model = gltf.scene;
                    scene.add(model);
                    model.position.copy(reticle.position);
                    currentModel = modelName;
                },
                undefined,
                function (error) {
                    console.error('Error loading model', error);
                }
            );
        }

        function onRequestSession() {
            navigator.xr
                .requestSession("immersive-ar", { requiredFeatures: ["local", "hit-test"] })
                .then(onStartSession);
        }

        function onStartSession(session) {
            // three
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType("local");
            renderer.xr.setSession(session);
            // session
            xrSession = session;
            xrSession.requestReferenceSpace("viewer").then(refSpace => {
                xrViewerSpace = refSpace;
                xrSession.requestHitTestSource({ space: xrViewerSpace }).then((hitTestSource) => {
                    xrHitTestSource = hitTestSource;
                });
            });
            xrSession.requestReferenceSpace("local").then(refSpace => {
                xrRefSpace = refSpace;
                renderer.setAnimationLoop(update);
            });
        }

        window.onload = () => {
            setup();
            if ("xr" in navigator) {
                const button = document.getElementById("xr-button");
                navigator.xr.isSessionSupported("immersive-ar").then((supported) => {
                    if (supported) {
                        button.disabled = !supported;
                    } else {
                        alert("Immersive AR is not supported on this device.");
                    }
                });
                button.addEventListener("click", onRequestSession);

                const model1Button = document.getElementById("model1-button");
                model1Button.addEventListener("click", function () {
                    if (xrSession && currentModel !== 'model1') {
                        loadModel('model1');
                    }
                });

                const model2Button = document.getElementById("model2-button");
                model2Button.addEventListener("click", function () {
                    if (xrSession && currentModel !== 'model2') {
                        loadModel('model2');
                    }
                });

                const model3Button = document.getElementById("model3-button");
                model3Button.addEventListener("click", function () {
                    if (xrSession && currentModel !== 'model3') {
                        loadModel('model3');
                    }
                });
            } else {
                alert("WebXR is not supported on this browser.");
            }
        }
    </script>
</body>

</html>
