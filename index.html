<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>reticle</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.117.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/GLTFLoader.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="container">
        <button id="xr-button">Tap To Start</button>
        <button class="model-btn" data-model="1.glb">Load Model 1</button>
        <button class="model-btn" data-model="2.glb">Load Model 2</button>
        <button class="model-btn" data-model="3.glb">Load Model 3</button>
        <button id="backbtn">Back</button>
    </div>
    <script>
        let renderer, camera, light, reticle, scene;
        let xrSession;
        let xrRefSpace;
        let xrViewerSpace;
        let xrHitTestSource;
        let planeDetected = false;
        const loader = new THREE.GLTFLoader();
        let model;
        let modelPlaced = false;
        let modelPath = '';
        let backBtn;
        let modelButtons;

        function setup() {
            renderer = new THREE.WebGLRenderer({
                antialias: false,
                alpha: true,
            });
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            light = new THREE.DirectionalLight(0xffffff, 0.7);
            light.position.set(1, 1, 1).normalize();
            const innerRadius = 0.04;
            const outerRadius = 0.05;
            const thetaSegments = 30;
            const phiSegments = 1;
            const geometry = new THREE.RingGeometry(innerRadius, outerRadius, thetaSegments, phiSegments);
            const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
            reticle = new THREE.Mesh(geometry, material);
            reticle.rotation.set(Math.PI * -0.5, 0, 0);
            reticle.visible = false;
            scene = new THREE.Scene();
            scene.add(light);
            scene.add(reticle);

            // Create the back button
            backBtn = document.getElementById("backbtn");
            backBtn.style.display = "none"; // Initially hide the back button
            backBtn.addEventListener("click", onBackButtonClick);
            document.body.appendChild(backBtn);

            // Get all model buttons
            modelButtons = document.querySelectorAll(".model-btn");
            modelButtons.forEach(btn => {
                btn.addEventListener("click", function () {
                    modelPath = this.getAttribute("data-model");
                    if (xrSession) {
                        loadModel(modelPath);
                    }
                });
            });
        }

        function update() {
            xrSession.requestAnimationFrame((time, frame) => {
                const pose = frame.getViewerPose(xrRefSpace);
                reticle.visible = false;
                if (xrHitTestSource && pose) {
                    const hitTestResults = frame.getHitTestResults(xrHitTestSource);
                    if (hitTestResults.length > 0 && !planeDetected) {
                        planeDetected = true;
                        const pose = hitTestResults[0].getPose(xrRefSpace);
                        const position = pose.transform.position;
                        reticle.visible = true;
                        reticle.position.set(position.x, position.y, position.z);
                        if (!modelPlaced && modelPath !== '') {
                            loadModel(modelPath);
                            modelPlaced = true;
                        }
                        xrHitTestSource.cancel();
                    }
                }
            });
            renderer.render(scene, camera);
        }

        function loadModel(path) {
            if (model) {
                scene.remove(model);
                model = null;
            }

            loader.load(
                path,
                function (gltf) {
                    model = gltf.scene;
                    scene.add(model);
                    model.position.copy(reticle.position);
                    backBtn.style.display = "block"; // Show the back button when the model is loaded
                },
                undefined,
                function (error) {
                    console.error('Error loading model', error);
                }
            );
        }

        function onRequestSession() {
            navigator.xr
                .requestSession("immersive-ar", { requiredFeatures: ["local", "hit-test"] })
                .then(onStartSession);
        }

        function onStartSession(session) {
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType("local");
            renderer.xr.setSession(session);
            xrSession = session;
            xrSession.requestReferenceSpace("viewer").then(refSpace => {
                xrViewerSpace = refSpace;
                xrSession.requestHitTestSource({ space: xrViewerSpace }).then((hitTestSource) => {
                    xrHitTestSource = hitTestSource;
                });
            });
            xrSession.requestReferenceSpace("local").then(refSpace => {
                xrRefSpace = refSpace;
                renderer.setAnimationLoop(update);
            });
        }

        function onBackButtonClick() {
            backBtn.style.display = "none"; // Hide the back button

            // Show model buttons again
            modelButtons.forEach(btn => {
                btn.style.display = "block";
            });

            // Remove the loaded model from the scene
            if (model) {
                scene.remove(model);
                model = null;
                modelPlaced = false;
            }
        }

        window.onload = () => {
            setup();
            if ("xr" in navigator) {
                const button = document.getElementById("xr-button");
                navigator.xr.isSessionSupported("immersive-ar").then((supported) => {
                    if (supported) {
                        button.disabled = !supported;
                    } else {
                        alert("AR not supported");
                    }
                });
                button.addEventListener("click", onRequestSession);
            } else {
                alert("WebXR not supported!");
            }
        }
    </script>
</body>

</html>
